<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tests Guardia Civil | Oposit.ai</title>
  <link rel="stylesheet" href="../style.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0fdf4;
      padding: 2rem;
    }

    h1 {
      text-align: center;
      color: #2e7d32;
      margin-bottom: 1rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }

    .tema {
      background-color: #a5d6a7;
      padding: 1.2rem;
      border-radius: 12px;
      text-align: center;
      font-weight: bold;
      cursor: pointer;
      transition: background-color 0.2s, transform 0.2s;
    }

    .tema:hover {
      background-color: #81c784;
      transform: scale(1.03);
    }

    .tema.seleccionado {
  border: 3px solid #2e7d32;
  background-color: #4caf50; /* verde m√°s intenso */
  color: white;
}

    button {
      margin-top: 1rem;
      padding: 0.8rem 1.5rem;
      font-weight: bold;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h1>Selecciona los temas para el test</h1>

  <!-- Grid de temas -->
  <div class="grid" id="temas-container">
    <div class="tema" data-tema="derechos_humanos">Tema 1: Derechos Humanos</div>
    <div class="tema" data-tema="igualdad">Tema 2: Igualdad</div>
    <div class="tema" data-tema="riesgos_laborales">Tema 3: Riesgos Laborales</div>
    <div class="tema" data-tema="derecho_constitucional">Tema 4: Derecho Constitucional</div>
    <div class="tema" data-tema="union_europea">Tema 5: Uni√≥n Europea</div>
    <div class="tema" data-tema="instituciones_internacionales">Tema 6: Instituciones Internacionales</div>
    <div class="tema" data-tema="derecho_civil">Tema 7: Derecho Civil</div>
    <div class="tema" data-tema="derecho_penal">Tema 8: Derecho Penal</div>
    <div class="tema" data-tema="derecho_procesal_penal">Tema 9: Derecho Procesal Penal</div>
    <div class="tema" data-tema="derecho_administrativo">Tema 10: Derecho Administrativo</div>
    <div class="tema" data-tema="proteccion_datos">Tema 11: Protecci√≥n de Datos</div>
    <div class="tema" data-tema="extranjeria_inmigracion">Tema 12: Extranjer√≠a e Inmigraci√≥n</div>
    <div class="tema" data-tema="seguridad_publica_privada">Tema 13: Seguridad P√∫blica y Privada</div>
    <div class="tema" data-tema="ministerio_interior_defensa">Tema 14: Ministerio Interior y Defensa</div>
    <div class="tema" data-tema="fuerzas_cuerpos_seguridad">Tema 15: Fuerzas y Cuerpos de Seguridad</div>
    <div class="tema" data-tema="materias_sociocultura">Tema 16: Materias de Socio-cultura</div>
    <div class="tema" data-tema="tecnologias_informacion">Tema 17: Tecnolog√≠as de la Informaci√≥n</div>
    <div class="tema" data-tema="topografia">Tema 18: Topograf√≠a</div>
    <div class="tema" data-tema="deontologia">Tema 19: Deontolog√≠a</div>
    <div class="tema" data-tema="responsabilidad_menores">Tema 20: Responsabilidad penal de los menores</div>
    <div class="tema" data-tema="violencia_genero">Tema 21: Protecci√≥n Integral contra la Violencia de G√©nero</div>
    <div class="tema" data-tema="armas_explosivos">Tema 22: Armas y Explosivos</div>
    <div class="tema" data-tema="derecho_fiscal">Tema 23: Derecho Fiscal</div>
  </div>

  <button id="comenzar-test">Comenzar test</button>

  <div id="test" style="margin-top: 2rem;"></div>

  <script>
    // =========================
    // üîπ BANCO DE PREGUNTAS VAC√çO
    // =========================
    // A√±ade aqu√≠ tus preguntas por tema siguiendo este formato:
    // "clave_tema": [
    //   { pregunta: "...", opciones: ["...","..."], correcta: "...", justificacion: "..." },
    //   ...
    // ]
    let preguntasBanco = {
      "derechos_humanos": [
        // A√±adir preguntas aqu√≠
      ],
      "igualdad": [
        // A√±adir preguntas aqu√≠
      ],
      "riesgos_laborales": [],
      "derecho_constitucional": [],
      "union_europea": [],
      "instituciones_internacionales": [],
      "derecho_civil": [],
      "derecho_penal": [],
      "derecho_procesal_penal": [],
      "derecho_administrativo": [],
      "proteccion_datos": [],
      "extranjeria_inmigracion": [],
      "seguridad_publica_privada": [],
      "ministerio_interior_defensa": [],
      "fuerzas_cuerpos_seguridad": [],
      "materias_sociocultura": [],
      "tecnologias_informacion": [],
      "topografia": [],
      "deontologia": [],
      "responsabilidad_menores": [],
      "violencia_genero": [],
      "armas_explosivos": [],
      "derecho_fiscal": []
    };

    // =========================
    // üîπ Selecci√≥n de temas
    // =========================
    const temasContainer = document.getElementById("temas-container");
    let temasSeleccionados = [];

    temasContainer.addEventListener("click", (e) => {
      const tema = e.target.closest(".tema");
      if (!tema) return;

      const temaId = tema.dataset.tema;

      if (temasSeleccionados.includes(temaId)) {
        temasSeleccionados = temasSeleccionados.filter(t => t !== temaId);
        tema.classList.remove("seleccionado");
      } else {
        temasSeleccionados.push(temaId);
        tema.classList.add("seleccionado");
      }
    });

    // =========================
    // üîπ Combinar preguntas seleccionadas
    // =========================
    function combinarPreguntasSeleccionadas() {
      let combinadas = [];
      temasSeleccionados.forEach(t => {
        if (preguntasBanco[t]) {
          combinadas = combinadas.concat(preguntasBanco[t]);
        }
      });
      return combinadas;
    }

    // =========================
    // üîπ Integrar con tu funci√≥n cargarTest
    // =========================
    const originalCargarTest = cargarTest;
    const comenzarBtn = document.getElementById("comenzar-test");
    comenzarBtn.addEventListener("click", () => {
      preguntasBanco = combinarPreguntasSeleccionadas();
      originalCargarTest();
    });

  
let totalPreguntasRenderizadas = 0;

function barajar(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
}

function setProgress(current, total) {
  const bar = document.getElementById('progressBar');
  const pct = total > 0 ? Math.round((current / total) * 100) : 0;
  bar.style.width = pct + '%';
  bar.title = pct + '%';
}
function shuffle(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

// Carga el test con preguntas y respuestas aleatorias
function cargarTest() {
  const numPreguntas = parseInt(document.getElementById('numPreguntas').value);
  const testForm = document.getElementById('testForm');
  const progressBar = document.getElementById('progressBar');
  const testResult = document.getElementById('testResult');

  testForm.innerHTML = '';
  testResult.innerHTML = '';
  progressBar.style.width = '0%';

  if (!preguntasBanco || preguntasBanco.length === 0) {
    testForm.innerHTML = '<p style="color:red;font-weight:bold;">‚ö†Ô∏è No hay preguntas en el banco.</p>';
    return;
  }

  const letras = ['a)', 'b)', 'c)', 'd)', 'e)', 'f)']; // por si hay m√°s de 4 opciones
  const preguntasSeleccionadas = shuffle([...preguntasBanco]).slice(0, numPreguntas);

  preguntasSeleccionadas.forEach((preguntaObj, index) => {
    // Mezclamos las opciones (pero vamos a limpiar su prefijo "a) " si lo llevan)
    const opcionesMezcladas = shuffle([...preguntaObj.opciones]);

    // Convertimos cada opci√≥n en un objeto { texto, esCorrecta }
    const opcionesObj = opcionesMezcladas.map(opcion => {
      // Limpiar prefijos como "a) ", "b) " si existen
      const textoLimpio = opcion.replace(/^[A-Za-z]\)\s*/, '').trim();
      const esCorrecta = opcion === preguntaObj.correcta || textoLimpio === preguntaObj.correcta.replace(/^[A-Za-z]\)\s*/, '').trim();
      return { texto: textoLimpio, esCorrecta };
    });

    // Renderizamos las opciones asignando letras seg√∫n la posici√≥n (letras fijas)
    const opcionesHTML = opcionesObj.map((opt, optIndex) => {
      const marcaCorrecta = opt.esCorrecta ? 'true' : 'false';
      const letra = letras[optIndex] || `${optIndex + 1})`; // fallback si hay >6 opciones
      // No incluimos la letra dentro del texto de la opci√≥n; la mostramos separada
      return `
        <label class="option">
          <input type="radio" name="pregunta${index}" value="${opt.texto.replace(/"/g, '&quot;')}" data-correct="${marcaCorrecta}">
          <span style="font-weight:700; margin-right:10px; color:var(--muted)">${letra}</span>
          ${opt.texto}
        </label>
      `;
    }).join('');

    const preguntaHTML = `
      <div class="question">
        <div class="q-head">
          <span class="q-num">${index + 1}.</span>
          <p class="q-text">${preguntaObj.pregunta}</p>
        </div>
        <div class="options">
          ${opcionesHTML}
        </div>
        <div class="justification muted" style="display:none;">
          <span class="correct">‚úî ${preguntaObj.correcta.replace(/^[A-Za-z]\)\s*/, '')}</span><br>
          ${preguntaObj.justificacion}
        </div>
      </div>
    `;
    testForm.insertAdjacentHTML('beforeend', preguntaHTML);
  });

  // A√±adir bot√≥n corregir (evitar duplicados)
  const botonCorregirExistente = Array.from(testForm.getElementsByTagName('button')).find(b => b.textContent === 'Corregir');
  if (!botonCorregirExistente) {
    const botonCorregir = document.createElement('button');
    botonCorregir.type = 'button';
    botonCorregir.className = 'btn success';
    botonCorregir.textContent = 'Corregir';
    botonCorregir.onclick = () => corregirTest();
    testForm.appendChild(botonCorregir);
  }
}


function corregirTest() {
  const preguntas = document.querySelectorAll('.question');
  let aciertos = 0;

  preguntas.forEach((pregunta) => {
    const radios = pregunta.querySelectorAll('input[type="radio"]');
    const labels = pregunta.querySelectorAll('.option');
    const justificacion = pregunta.querySelector('.justification');
    let seleccionCorrecta = false;

    // Limpiar clases anteriores
    labels.forEach(l => {
      l.classList.remove('correct-option', 'wrong-option');
      const checkmark = l.querySelector('.checkmark');
      if (checkmark) checkmark.remove();
    });

    radios.forEach(radio => {
      const label = radio.closest('.option');
      if (radio.checked && radio.dataset.correct === 'true') {
        seleccionCorrecta = true;
      }
    });

    radios.forEach(radio => {
      const label = radio.closest('.option');

      if (radio.dataset.correct === 'true') {
        // Mostrar check verde en la opci√≥n correcta
        label.classList.add('correct-option');
        label.insertAdjacentHTML('afterbegin', `<span class="checkmark" style="color:#059669;font-weight:700;">‚úî</span>`);
      }

      if (radio.checked && radio.dataset.correct !== 'true') {
        // Mostrar X roja en la opci√≥n elegida incorrecta
        label.classList.add('wrong-option');
        label.insertAdjacentHTML('afterbegin', `<span class="checkmark" style="color:#dc2626;font-weight:700;">‚úò</span>`);
      }
    });

    // Mostrar la justificaci√≥n al final
    if (justificacion) {
      justificacion.style.display = 'block';
      justificacion.innerHTML = `
        ${seleccionCorrecta 
          ? `<span class="correct">‚úî ${pregunta.querySelector('input[data-correct="true"]').value}</span><br>` 
          : `<span class="incorrect">‚úò ${pregunta.querySelector('input[data-correct="true"]').value}</span><br>`
        }
        ${pregunta.querySelector('.justification').textContent || ''}
      `;
    }

    if (seleccionCorrecta) aciertos++;
  });

  // Mostrar resultado final
  const total = preguntas.length;
  const porcentaje = Math.round((aciertos / total) * 100);
  const testResult = document.getElementById('testResult');
  testResult.innerHTML = `
    <div class="result-card">
      <p class="score">Has acertado ${aciertos} de ${total} preguntas (${porcentaje}%).</p>
      <p class="muted">${porcentaje >= 70 ? "‚úÖ ¬°Buen trabajo!" : "‚ùå Puedes mejorar."}</p>
    </div>
  `;
  document.getElementById('progressBar').style.width = '100%';
}


function reiniciarTest() {
  document.getElementById('testForm').innerHTML = '';
  document.getElementById('testResult').innerHTML = '';
  setProgress(0, 0);
}
  // ==========================
// üîπ TEMPORIZADOR CONFIGURABLE
// ==========================

// Variables del temporizador
let tiempoTotal = 0;
let tiempoRestante = 0;
let temporizadorInterval;

// Crear selector de tiempo en el panel de controles
const selectTiempo = document.createElement('select');
selectTiempo.id = 'tiempoSeleccionado';
selectTiempo.innerHTML = `
  <option value="0">Sin l√≠mite</option>
  <option value="5">5 minutos</option>
  <option value="10" selected>10 minutos</option>
  <option value="15">15 minutos</option>
  <option value="20">20 minutos</option>
  <option value="30">30 minutos</option>
  <option value="40">40 minutos</option>
  <option value="50">50 minutos</option>
  <option value="60">60 minutos</option>
`;
const labelTiempo = document.createElement('label');
labelTiempo.htmlFor = 'tiempoSeleccionado';
labelTiempo.textContent = 'Tiempo l√≠mite:';
const controlsDiv = document.querySelector('.controls');
controlsDiv.insertBefore(labelTiempo, controlsDiv.children[2]);
controlsDiv.insertBefore(selectTiempo, controlsDiv.children[3]);

// Crear elemento visual del temporizador
const temporizadorDiv = document.createElement('div');
temporizadorDiv.id = 'temporizador';
temporizadorDiv.style.textAlign = 'center';
temporizadorDiv.style.fontSize = '18px';
temporizadorDiv.style.fontWeight = '700';
temporizadorDiv.style.color = '#2563eb';
temporizadorDiv.style.marginTop = '12px';
controlsDiv.appendChild(temporizadorDiv);

// Mostrar tiempo en formato mm:ss
function mostrarTiempo() {
  let min = Math.floor(tiempoRestante / 60);
  let seg = tiempoRestante % 60;
  temporizadorDiv.textContent = `‚è≥ Tiempo restante: ${min}:${seg.toString().padStart(2, '0')}`;
}

// Iniciar temporizador
function iniciarTemporizador() {
  const minutosSeleccionados = parseInt(document.getElementById('tiempoSeleccionado').value);
  if (minutosSeleccionados === 0) {
    temporizadorDiv.textContent = '‚è≥ Sin l√≠mite de tiempo';
    return;
  }

  tiempoTotal = minutosSeleccionados * 60;
  tiempoRestante = tiempoTotal;
  mostrarTiempo();

  temporizadorInterval = setInterval(() => {
    tiempoRestante--;
    mostrarTiempo();
    if (tiempoRestante <= 0) {
      clearInterval(temporizadorInterval);
      temporizadorDiv.textContent = '‚è∞ ¬°Tiempo agotado!';
      finalizarTestPorTiempo();
    }
  }, 1000);
}

// Detener temporizador
function detenerTemporizador() {
  clearInterval(temporizadorInterval);
}

// Modificar funci√≥n cargarTest para que inicie el temporizador
const originalCargarTest = cargarTest;
cargarTest = function() {
  originalCargarTest();
  detenerTemporizador(); // Por si se reinicia
  iniciarTemporizador();
};

// Al finalizar el test manualmente (bot√≥n Enviar)
const originalEvaluarTest = evaluarTest;
evaluarTest = function() {
  detenerTemporizador(); // Detiene el contador al pulsar Enviar
  originalEvaluarTest();
};

// Cuando el tiempo se agota autom√°ticamente
function finalizarTestPorTiempo() {
  // Evita ejecuciones dobles
  if (window.__finalizadoPorTiempo__) return;
  window.__finalizadoPorTiempo__ = true;

  detenerTemporizador();
  if (temporizadorDiv) temporizadorDiv.textContent = '‚è∞ ¬°Tiempo agotado! Pulsa "Enviar" para corregir.';

  // üîí Bloquear todas las respuestas
  document.querySelectorAll('input[type="radio"]').forEach(r => {
    r.disabled = true;
    const opt = r.closest('.option');
    if (opt) {
      opt.style.opacity = '0.6';
      opt.style.pointerEvents = 'none';
    }
  });

  // ‚úÖ Dejar el bot√≥n "Enviar" activo y hacerlo destacar en verde
  const btnEnviar = document.querySelector('button.btn.success, button[type="submit"]');
  if (btnEnviar) {
    btnEnviar.disabled = false;
    btnEnviar.style.opacity = '1';
    btnEnviar.style.cursor = 'pointer';

    // üíö Efecto parpadeo verde suave
    btnEnviar.style.animation = 'blinkGreen 1.2s infinite';
    btnEnviar.style.transition = 'background-color 0.3s ease';
    btnEnviar.style.backgroundColor = '#22c55e'; // verde suave (Tailwind: green-500)
    btnEnviar.style.color = 'white';

    // Inyectar animaci√≥n CSS si no existe
    if (!document.getElementById('blinkGreen-style')) {
      const style = document.createElement('style');
      style.id = 'blinkGreen-style';
      style.textContent = `
        @keyframes blinkGreen {
          0%, 100% { background-color: #22c55e; }
          50% { background-color: #86efac; } /* verde claro (green-300) */
        }
      `;
      document.head.appendChild(style);
    }
  }

  // üîÑ Mantener bot√≥n "Reiniciar" activo
  const btnReiniciar = document.querySelector('button.btn.secondary');
  if (btnReiniciar) {
    btnReiniciar.disabled = false;
  }
}
</script>
</body>
</html>
